<p id="notice"><%= notice %></p>

<p>
  <strong>Id:</strong>
  <%= @post.id %>
  <strong>Mediaclip_id:</strong>
  <%= @post.mediaclip_id %>
</p>

<script src="https://demo.bbvms.com/launchpad/"></script>

<div id="myPlayerDiv"></div>

<%= link_to 'Back', posts_path %>



<script>

const apiUri = "https://jsonplaceholder.typicode.com/users";

const user = "<%= @user %>" || localStorage.getItem("user_id");
const mediaclipId = "<%= @post.mediaclip_id%>";

let pastFourtyPercent = false;

let myPlayer = new bluebillywig.Player( `https://demo.bbvms.com/p/default/c/${mediaclipId}.json`, {
  target: document.getElementById("myPlayerDiv"),
  autoPlay: "false"
});

const patchUser = (body) => {
  fetch(`${apiUri}/${user}`, {
    method: 'PATCH',
    body: JSON.stringify(body),
    headers: {
      'Content-type': 'application/json; charset=UTF-8',
    },
  })
    .then((response) => response.json())
    .then((json) => console.log(json));
}

const onEnded = () => {
  patchUser({ watchedToEnd: mediaclipId });
};

const onFourtyPercent = () => {
  if(!pastFourtyPercent) {
    pastFourtyPercent = true;

    patchUser({ watchedFourtyPercent: mediaclipId });
  }
};

const onTimeupdate = () => {
  let currentTime = myPlayer.getCurrentTime();
  let maxTime = myPlayer.getDuration();

  if (!pastFourtyPercent && currentTime / maxTime >= 0.4) {
    onFourtyPercent();
  }
}

if (user != null) {
  myPlayer.on('ended', onEnded);
  myPlayer.on('timeupdate', onTimeupdate);
}

myPlayer.play();

</script>
